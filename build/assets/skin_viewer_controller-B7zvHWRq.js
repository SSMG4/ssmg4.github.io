import{C as b}from"./pulsar-Z0XEwoqe.js";import{S as w,N as y}from"./viewer-Dr3l7UVh.js";class k{constructor(){Object.defineProperty(this,"speed",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"paused",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"progress",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"currentId",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"progress0",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"animationObjects",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}update(e,t){if(this.paused)return;const i=t*this.speed;this.animate(e,i),this.animationObjects.forEach((a,n)=>{const o=this.progress0.get(n);a(e,this.progress-o,n)}),this.progress+=i}addAnimation(e){const t=this.currentId++;return this.progress0.set(t,this.progress),this.animationObjects.set(t,e),t}removeAnimation(e){e!=null&&(this.animationObjects.delete(e),this.progress0.delete(e))}}class V extends k{animate(e){const t=this.progress*2,i=Math.PI*.02;e.skin.leftArm.rotation.z=Math.cos(t)*.03+i,e.skin.rightArm.rotation.z=Math.cos(t+Math.PI)*.03-i;const a=Math.PI*.06;e.cape.rotation.x=Math.sin(t)*.01+a}}class M extends k{constructor(){super(...arguments),Object.defineProperty(this,"headBobbing",{enumerable:!0,configurable:!0,writable:!0,value:!0})}animate(e){const t=this.progress*8;e.skin.leftLeg.rotation.x=Math.sin(t)*.5,e.skin.rightLeg.rotation.x=Math.sin(t+Math.PI)*.5,e.skin.leftArm.rotation.x=Math.sin(t+Math.PI)*.5,e.skin.rightArm.rotation.x=Math.sin(t)*.5;const i=Math.PI*.02;e.skin.leftArm.rotation.z=Math.cos(t)*.03+i,e.skin.rightArm.rotation.z=Math.cos(t+Math.PI)*.03-i,this.headBobbing?(e.skin.head.rotation.y=Math.sin(t/4)*.2,e.skin.head.rotation.x=Math.sin(t/5)*.1):(e.skin.head.rotation.y=0,e.skin.head.rotation.x=0);const a=Math.PI*.06;e.cape.rotation.x=Math.sin(t/1.5)*.06+a}}class x extends k{animate(e){const t=this.progress*15+Math.PI*.5;e.skin.leftLeg.rotation.x=Math.cos(t+Math.PI)*1.3,e.skin.rightLeg.rotation.x=Math.cos(t)*1.3,e.skin.leftArm.rotation.x=Math.cos(t)*1.5,e.skin.rightArm.rotation.x=Math.cos(t+Math.PI)*1.5;const i=Math.PI*.1;e.skin.leftArm.rotation.z=Math.cos(t)*.1+i,e.skin.rightArm.rotation.z=Math.cos(t+Math.PI)*.1-i,e.position.y=Math.cos(t*2),e.position.x=Math.cos(t)*.15,e.rotation.z=Math.cos(t+Math.PI)*.01;const a=Math.PI*.3;e.cape.rotation.x=Math.sin(t*2)*.1+a}}function v(u,e,t){return u<=e?e:u>=t?t:u}class P extends k{animate(e){const t=this.progress>0?this.progress*20:0,i=v(t*t/100,0,1);e.rotation.x=i*Math.PI/2,e.skin.head.rotation.x=i>.5?Math.PI/4-e.rotation.x:0;const a=Math.PI*.25*i;e.skin.leftArm.rotation.z=a,e.skin.rightArm.rotation.z=-a;const n=.34906584,o=Math.PI/2,s=Math.pow(.9,t);e.elytra.leftWing.rotation.x=n+s*(.2617994-n),e.elytra.leftWing.rotation.z=o+s*(.2617994-o),e.elytra.updateRightWing()}}class S extends k{constructor(e="left"){super(),Object.defineProperty(this,"whichArm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.whichArm=e}animate(e){const t=this.progress*2*Math.PI*.5,i=this.whichArm==="left"?e.skin.leftArm:e.skin.rightArm;i.rotation.x=180,i.rotation.z=Math.sin(t)*.5}}import.meta.stimulusFetch="lazy";import.meta.stimulusIdentifier="skin-viewer";class U extends b{static targets=["item","skinTrigger","capeTrigger"];static values={skinUrl:String,capeUrl:String,viewType:String,isRotating:{type:Boolean,default:!1},username:String,modelType:{type:String,default:"auto"},elytraDisplayed:{type:Boolean,default:!1},elytraFlying:{type:Boolean,default:!1},originalSkinUrl:String,fallbackMode:{type:Boolean,default:!1}};animations={idle:()=>new V,walk:()=>{const e=new M;return e.speed=.6,e.headBobbing=!1,e},run:()=>{const e=new x;return e.speed=.5,e},wave:()=>new S("right"),fly:()=>new P};#e=null;skinViewer=null;connect(){this.hasViewTypeValue||(this.viewTypeValue="skin"),this.hasSkinUrlValue&&(this.skinUrlValue=this.skinUrlValue.replace("http://","https://")),this.hasCapeUrlValue&&(this.capeUrlValue=this.capeUrlValue.replace("http://","https://")),this.checkGPUAcceleration().then(e=>{e?(this.initializeResizeObserver(),this.initializeSkinViewer().then(t=>{this.skinViewer=t,this.renderPlayer(t,!0)})):(this.fallbackModeValue=!0,this.renderStaticImage(),this.disableInteractiveFeatures())})}async checkGPUAcceleration(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return!1;const i=t.getExtension("WEBGL_debug_renderer_info");if(i){const l=t.getParameter(i.UNMASKED_RENDERER_WEBGL);if(l.includes("SwiftShader")||l.includes("Mesa")||l.includes("Microsoft"))return!1}const a=document.createElement("canvas");a.width=64,a.height=64;const n=a.getContext("webgl");if(!n)return!1;const o=performance.now();for(let l=0;l<100;l++)n.clear(n.COLOR_BUFFER_BIT);return performance.now()-o<50}catch{return!1}}async renderStaticImage(){if(!(!this.hasSkinUrlValue&&!this.hasCapeUrlValue))try{const e=await this.createOffscreenSkinViewer();if(this.viewTypeValue==="skin"&&this.hasSkinUrlValue){let i={};this.hasUsernameValue&&this.usernameValue==="deadmau5"&&(i.ears=!0),this.modelTypeValue==="slim"?i.model="slim":this.modelTypeValue==="default"&&(i.model="default"),await e.loadSkin(this.skinUrlValue,i)}else this.viewTypeValue==="cape"&&this.hasCapeUrlValue&&await e.loadCape(this.capeUrlValue);e.fxaaPass.enabled=!0,e.render();const t=e.canvas.toDataURL("image/png");this.replaceWithImage(t),e.dispose(),this.showFallbackMessage()}catch{this.showErrorMessage()}}async createOffscreenSkinViewer(){const e=this.itemTarget.parentElement,{width:t,height:i}=e.getBoundingClientRect(),a=window.devicePixelRatio||1,n=Math.floor(t*a),o=Math.floor(i*a),s=new w({width:n,height:o,renderPaused:!0});return s.fov=35,this.viewTypeValue==="skin"?(s.playerWrapper.rotation.y=325*Math.PI/180,s.playerWrapper.rotation.x=20.55*Math.PI/180,s.zoom=.75):(s.playerWrapper.rotation.y=Math.PI,s.playerObject.cape.position.z=0,s.playerObject.cape.rotation.x=0,s.playerObject.skin.visible=!1,s.zoom=1.75),s.renderer.antialias=!0,s.renderer.shadowMap.enabled=!0,s.renderer.shadowMap.type=s.renderer.constructor.PCFSoftShadowMap,s}replaceWithImage(e){const t=new Image;t.onload=()=>{const i=this.itemTarget,a=i.getContext("2d"),n=i.parentElement,{width:o,height:s}=n.getBoundingClientRect(),l=window.devicePixelRatio||1;i.width=o*l,i.height=s*l,i.style.width=o+"px",i.style.height=s+"px",a.scale(l,l),a.clearRect(0,0,o,s);const h=t.width/t.height,d=o/s;let r,c,g,m;h>d?(r=o,c=o/h,g=0,m=(s-c)/2):(r=s*h,c=s,g=(o-r)/2,m=0),a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(t,g,m,r,c)},t.src=e}showFallbackMessage(){const e=this.itemTarget.parentElement,t=document.createElement("div");t.className="fallback-message",t.style.cssText=`
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            z-index: 10;
        `,t.textContent="Static view (GPU acceleration unavailable)",e.style.position="relative",e.appendChild(t)}showErrorMessage(){this.itemTarget.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Unable to render skin/cape</div>'}disableInteractiveFeatures(){this.element.querySelectorAll('[data-action*="toggleRotation"], [data-action*="setAnimation"], [data-action*="toggleLayer"], [data-action*="toggleElytra"]').forEach(t=>{t.disabled=!0,t.style.opacity="0.5",t.title="Feature disabled in fallback mode"})}async initializeSkinViewer(){if(this.fallbackModeValue)return null;const e=this.itemTarget.parentElement,{width:t,height:i}=e.getBoundingClientRect();let a=new w({canvas:this.itemTarget,width:t,height:i});const n=a.controls;return n.enableZoom=!1,n.maxDistance=150,n.minDistance=10,n.enablePan=!1,this.viewTypeValue==="cape"?(a.playerObject.skin.visible=!1,a.playerObject.cape.position.z=0,a.playerObject.cape.rotation.x=0,a.playerWrapper.rotation.y=Math.PI):(a.playerWrapper.rotation.y=0,a.animation=new V),a.playerObject.cape.visible=this.viewTypeValue==="cape",a.cameraLight.intensity=200,this.adjustCameraPosition(),a}initializeResizeObserver(){this.fallbackModeValue||(this.resizeObserver=new ResizeObserver(e=>{for(const t of e)if(this.skinViewer){const{width:i,height:a}=t.contentRect;this.skinViewer.setSize(i,a),this.adjustCameraPosition()}}),this.resizeObserver.observe(this.itemTarget.parentElement))}async generateFavicon(){if(!(!this.skinViewer||!this.hasSkinUrlValue||this.fallbackModeValue))try{const e=new Image;await new Promise((h,d)=>{e.onload=h,e.onerror=d,e.crossOrigin="Anonymous",e.src=this.skinUrlValue});const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0);const a=[16,32,64],n={};for(const h of a){const d=document.createElement("canvas");d.width=h,d.height=h;const r=d.getContext("2d");r.imageSmoothingEnabled=!1,r.webkitImageSmoothingEnabled=!1,r.mozImageSmoothingEnabled=!1,r.msImageSmoothingEnabled=!1;const c=h/8;for(let g=0;g<8;g++)for(let m=0;m<8;m++){const f=i.getImageData(8+m,8+g,1,1).data,p=i.getImageData(40+m,8+g,1,1).data;f[3]>0&&(r.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${f[3]/255})`,r.fillRect(m*c,g*c,c,c)),p[3]>0&&(r.fillStyle=`rgba(${p[0]}, ${p[1]}, ${p[2]}, ${p[3]/255})`,r.fillRect(m*c,g*c,c,c))}n[h]=d.toDataURL("image/png")}document.querySelectorAll('link[rel*="icon"]').forEach(h=>h.parentNode.removeChild(h));const s=new Date().getTime();for(const[h,d]of Object.entries(n)){const r=document.createElement("link");r.rel="icon",r.type="image/png",r.sizes=`${h}x${h}`,r.href=`${d}?t=${s}`,document.head.appendChild(r)}const l=document.createElement("link");l.rel="shortcut icon",l.type="image/png",l.href=`${n[32]}`,document.head.appendChild(l)}catch{}}setAnimation({target:{value:e}}){this.fallbackModeValue||this.changeAnimation(e)}toggleLayer(e){if(!this.skinViewer||this.fallbackModeValue)return;const t=e.target.dataset.layer,i=e.target.checked;if(t==="nameTag"){const n=this.usernameValue;this.skinViewer.nameTag=i?new y(n):null;return}const a=this.skinViewer.playerObject.skin;a[t]&&(a[t].outerLayer.visible=i)}async toggleElytra(){!this.skinViewer||this.viewTypeValue!=="cape"||this.fallbackModeValue||(this.elytraDisplayedValue?this.elytraFlyingValue?await this.showCapeMode():this.showFlyingMode():await this.showElytraMode())}async showElytraMode(){this.hasSkinUrlValue&&!this.hasOriginalSkinUrlValue&&(this.originalSkinUrlValue=this.skinUrlValue),await this.skinViewer.loadSkin("/images/minecraft/steve.png",{model:"default"}),this.skinViewer.playerObject.skin.visible=!0,this.skinViewer.playerObject.cape.visible=!1,this.skinViewer.playerObject.backEquipment="elytra",this.skinViewer.zoom=.7,this.skinViewer.animation=this.animations.idle(),this.elytraDisplayedValue=!0,this.elytraFlyingValue=!1,this.updateElytraButtonText("Flying Mode")}showFlyingMode(){this.skinViewer.animation=this.animations.fly(),this.skinViewer.zoom=.7,this.skinViewer.playerWrapper.rotation.x=-.2,this.elytraFlyingValue=!0,this.updateElytraButtonText("Back to Cape")}async showCapeMode(){this.skinViewer&&(this.skinViewer.backgroundTexture&&this.skinViewer.backgroundTexture.dispose(),this.skinViewer=null),this.skinViewer=await this.initializeSkinViewer(),this.adjustCameraPosition(this.skinViewer),this.hasOriginalSkinUrlValue&&(this.skinUrlValue=this.originalSkinUrlValue),await this.renderPlayer(this.skinViewer),this.elytraDisplayedValue=!1,this.elytraFlyingValue=!1,this.updateElytraButtonText("Elytra")}updateElytraButtonText(e){const t=this.element.querySelector('[data-action*="toggleElytra"] span');t&&(t.textContent=e)}toggleRotation({target:{checked:e}}){this.fallbackModeValue||(this.isRotatingValue=e,e?this.startRotation():this.stopRotation())}changeModelType(e){this.fallbackModeValue||(this.modelTypeValue=e.target.value,this.skinViewer&&this.renderPlayer(this.skinViewer))}setModelDefault(){this.fallbackModeValue||(this.modelTypeValue="default",this.skinViewer&&this.renderPlayer(this.skinViewer))}setModelSlim(){this.fallbackModeValue||(this.modelTypeValue="slim",this.skinViewer&&this.renderPlayer(this.skinViewer))}setModelAuto(){this.fallbackModeValue||(this.modelTypeValue="auto",this.skinViewer&&this.renderPlayer(this.skinViewer))}changeAnimation(e){!this.skinViewer||!this.animations[e]||this.fallbackModeValue||(this.skinViewer.animation=this.animations[e]())}startRotation(){if(this.#e||this.fallbackModeValue)return;const e=()=>{this.skinViewer&&(this.skinViewer.playerWrapper.rotation.y+=.002,this.#e=requestAnimationFrame(e))};this.#e=requestAnimationFrame(e)}stopRotation(){this.#e&&(cancelAnimationFrame(this.#e),this.#e=null)}adjustCameraPosition(e=this.skinViewer){e&&(e.zoom=this.viewTypeValue==="skin"?.75:1.75)}async toggleBackground(){!this.skinViewer||this.fallbackModeValue||(this.hasBackgroundValue=!this.hasBackgroundValue,this.hasBackgroundValue?await this.skinViewer.loadPanorama("/images/minecraft/panorama.webp"):(this.skinViewer.scene.background=null,this.skinViewer.backgroundTexture&&(this.skinViewer.backgroundTexture.dispose(),this.skinViewer.backgroundTexture=null)))}async renderPlayer(e,t=!1){if(!this.fallbackModeValue){if(this.hasSkinUrlValue){let i={};this.hasUsernameValue&&this.usernameValue==="deadmau5"&&(i.ears=!0),this.modelTypeValue==="slim"?i.model="slim":this.modelTypeValue==="default"&&(i.model="default"),await e.loadSkin(this.skinUrlValue,i),this.hasUsernameValue&&(this.usernameValue==="Dinnerbone"||this.usernameValue==="Grumm")?e.playerWrapper.rotation.z=Math.PI:e.playerWrapper.rotation.z=0,t&&await this.generateFavicon()}this.hasCapeUrlValue&&(await e.loadCape(this.capeUrlValue),this.elytraDisplayedValue=!1)}}changeSkinUrl(e){const t=e.currentTarget.dataset.skinUrl;if(!t||!this.skinViewer&&!this.fallbackModeValue)return;const i=e.currentTarget.dataset.modelType;i&&(this.modelTypeValue=i),this.skinUrlValue=t,this.fallbackModeValue?this.renderStaticImage():this.renderPlayer(this.skinViewer)}changeCapeUrl(e){const t=e.currentTarget.dataset.capeUrl;!t||!this.skinViewer&&!this.fallbackModeValue||(this.capeUrlValue=t,this.fallbackModeValue?this.renderStaticImage():this.renderPlayer(this.skinViewer))}disconnect(){this.stopRotation(),this.resizeObserver&&this.resizeObserver.disconnect(),this.skinViewer&&(this.skinViewer.backgroundTexture&&this.skinViewer.backgroundTexture.dispose(),this.skinViewer=null),super.disconnect()}}export{U as default};
